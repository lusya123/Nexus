# Nexus 架构说明

## 核心设计理念

Nexus 是一个零配置的本地监控系统，自动发现并实时展示机器上所有 AI 编程工具的活跃 session。

**设计原则：**
- **零人工干预**：Session 自动出现、自动消失
- **进程驱动**：通过操作系统进程判断 session 存活状态
- **增量读取**：只解析文件新增内容，不重复读取
- **质量模型**：Session 停留时间与活跃时长成正比

## Session 生命周期

### 状态机

每个 session 有四种状态：

```
ACTIVE   → 进程在跑 + 文件最近有修改（正在工作）
IDLE     → 进程在跑 + 文件一段时间没修改（用户在思考）
COOLING  → 进程已退出，冷却倒计时中（逐渐淡出）
GONE     → 冷却期结束（从页面移除）
```

### 状态转换流程

```
新文件出现 ──→ ACTIVE
                 │
          文件持续修改 ←──┐
                 │        │
          2分钟无修改     │
                 ↓        │
               IDLE ──────┘ (文件再次修改)
                 │
           进程退出
                 ↓
             COOLING ──→ 冷却期结束 ──→ GONE（移除）
```

### 活跃判定机制

**进程存活 = Session 存活**

通过 `lsof` 命令扫描工具进程：

```bash
lsof -c claude -a -d cwd -F pcn 2>/dev/null
```

- 进程在 → session 开着
- 进程退出 → session 进入冷却期

每 15 秒执行一次进程扫描，结合 `fs.watch` 实时检测文件修改。

### 质量模型：动态冷却时间

Session 的冷却时间根据活跃时长动态计算：

```javascript
function getCooldownDuration(session) {
  const activeSeconds = (session.endTime - session.startTime) / 1000;
  // 活跃时间的 10%，限制在 3秒 ~ 5分钟
  return clamp(activeSeconds * 0.1, 3, 300);
}
```

**效果：**
- 10 秒快速任务 → 停留 3 秒后淡出
- 1 小时长对话 → 停留 6 分钟后淡出
- 自然形成视觉层次：重要的 session 停留更久

## 数据流

```
┌─────────────────┐
│  文件系统监听    │  fs.watch 监听 JSONL 文件
│  ~/.claude/     │
│  ~/.codex/      │
│  ~/.openclaw/   │
└────────┬────────┘
         │
         │ 文件修改事件
         ↓
┌─────────────────┐
│  增量读取器      │  记录字节偏移，只读新增行
│  fileOffsets    │
└────────┬────────┘
         │
         │ 解析 JSONL
         ↓
┌─────────────────┐
│  Session 管理器  │  维护状态机，管理生命周期
│  sessions Map   │
└────────┬────────┘
         │
         │ WebSocket 推送
         ↓
┌─────────────────┐
│  React 前端      │  实时渲染卡片，动画效果
│  浏览器         │
└─────────────────┘

         ↑
         │ 进程扫描（每 15 秒）
         │
┌─────────────────┐
│  lsof 进程扫描   │  检测工具进程存活状态
│  activeProcesses│
└─────────────────┘
```

## 核心组件

### 1. 文件监听系统

- **目录扫描**：启动时扫描所有工具的 session 目录
- **fs.watch**：监听文件创建和修改事件
- **增量读取**：使用 `fileOffsets` Map 记录每个文件的读取位置

### 2. 进程扫描器

- **定时扫描**：每 15 秒执行 `lsof` 命令
- **PID 映射**：将进程 PID 映射到工作目录
- **路径编码**：`/Users/xxx/project` → `-Users-xxx-project`

### 3. 状态管理器

- **sessions Map**：存储所有 session 的状态
- **状态转换**：根据文件修改和进程状态更新 session 状态
- **冷却定时器**：进程退出后启动倒计时

### 4. WebSocket 服务

- **实时推送**：文件修改、状态变化立即推送到浏览器
- **完整状态同步**：新客户端连接时推送所有 session 状态

### 5. React 前端

- **卡片网格**：响应式布局，按最后活动时间排序
- **动画系统**：错开入场、呼吸灯、淡出效果
- **自动滚动**：新消息到达时滚动到底部

## 扩展性设计

### 添加新工具支持

系统设计为易于扩展，添加新工具只需：

1. 在 `TOOL_CONFIGS` 中添加配置
2. 实现对应的 parser 函数
3. 添加进程扫描规则
4. 前端添加颜色主题

详见 [CONTRIBUTING.md](./CONTRIBUTING.md)

## 性能考虑

- **增量读取**：避免重复解析大文件
- **按需监听**：只监听有活跃 session 的目录
- **定时清理**：GONE 状态的 session 自动从内存移除
- **WebSocket 复用**：所有更新通过同一连接推送

## 未来扩展

**Phase 2 计划：**
- 添加 Codex 支持（`~/.codex/sessions/`）
- 添加 OpenClaw 支持（`~/.openclaw/agents/`）
- 多工具颜色区分
- 大规模 session 优化（支持数百个并发 session）
